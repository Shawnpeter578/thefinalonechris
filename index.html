<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>PROJECT FIDA</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&family=Libre+Barcode+39+Text&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

  <style>
    /* =========================================
       THEME: PREMIUM OBSIDIAN GLASS (RED EDITION)
       ========================================= */
    :root {
      --font-main: 'Inter', sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --font-barcode: 'Libre Barcode 39 Text', cursive;
      
      /* --- PALETTE (Dark) --- */
      --bg-body: #050505;
      --bg-surface: #111111;
      --bg-surface-glass: rgba(20, 20, 20, 0.7);
      --bg-ticket: #1a1a1a;
      
      /* Accent: Crimson / Vibrant Red */
      --accent: #FF3B30;
      --accent-dark: #C41E3A;
      --accent-glow: rgba(255, 59, 48, 0.4);
      --accent-grad: linear-gradient(135deg, #FF3B30 0%, #D70015 100%);
      
      --text-main: #ffffff;
      --text-sec: #a3a3a3;
      --text-muted: #52525b;
      
      --border: rgba(255, 255, 255, 0.08);
      --border-highlight: rgba(255, 69, 58, 0.25);
      
      --nav-glass: rgba(10, 10, 10, 0.85);
      --blur: blur(20px);

      --radius-sm: 8px;
      --radius-md: 20px;
      --radius-lg: 32px;
      
      --header-height: 70px;
      --safe-bottom: env(safe-area-inset-bottom, 20px);
      
      --shadow-sm: 0 4px 20px -2px rgba(0,0,0,0.3);
      --shadow-glow: 0 0 40px -10px rgba(255, 59, 48, 0.25);
    }

    /* --- LIGHT MODE (Crimson Daybreak) --- */
    [data-theme="light"] {
      --bg-body: #f2f2f7; /* Clean platinum */
      --bg-surface: #ffffff;
      --bg-surface-glass: rgba(255, 255, 255, 0.85);
      --bg-ticket: #ffffff;
      
      /* Crisp, Bold Red Accents */
      --accent: #E02424; 
      --accent-dark: #9B1C1C;
      --accent-glow: rgba(224, 36, 36, 0.1);
      --accent-grad: linear-gradient(135deg, #E02424 0%, #F05252 100%);
      
      --text-main: #0f172a; /* Deep Slate for contrast */
      --text-sec: #475569;
      --text-muted: #94a3b8;
      
      --border: #e2e8f0;
      --border-highlight: #fda4af;
      
      --nav-glass: rgba(255, 255, 255, 0.9);
      
      /* Soft, realistic shadows for depth on light bg */
      --shadow-sm: 0 2px 4px -1px rgba(0, 0, 0, 0.06), 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      --shadow-glow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    
    body {
      background-color: var(--bg-body);
      color: var(--text-main);
      font-family: var(--font-main);
      overflow-x: hidden;
      padding-bottom: calc(100px + var(--safe-bottom));
      transition: background 0.4s ease, color 0.4s ease;
      letter-spacing: -0.01em;
      /* Subtle ambient gradient */
      background-image: radial-gradient(circle at 50% -20%, var(--accent-glow), transparent 70%);
      background-attachment: fixed;
    }

    .hidden { display: none !important; }

    /* =========================================
       COMPONENTS
       ========================================= */
    
    /* Splash Screen - Simplified */
    #splashScreen {
      position: fixed; inset: 0; background: var(--bg-body); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.6s ease-in-out, visibility 0.6s;
    }
    #splashScreen.hide { opacity: 0; visibility: hidden; pointer-events: none; }
    
    .splash-logo {
      font-size: 4rem; font-weight: 800; letter-spacing: -0.05em;
      background: var(--text-main); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      opacity: 0; animation: fadeUpSplash 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards 0.2s;
      position: relative;
    }
    .splash-logo::after {
        content: ''; position: absolute; bottom: 10px; right: -12px;
        width: 8px; height: 8px; background: var(--accent); border-radius: 50%;
        box-shadow: 0 0 12px var(--accent);
    }
    
    @keyframes fadeUpSplash { 
        0% { opacity: 0; transform: scale(0.95); } 
        100% { opacity: 1; transform: scale(1); } 
    }

    /* Auth Screen - Redesigned */
    .auth-container {
        position: fixed; inset: 0; background: var(--bg-body); z-index: 2000;
        display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px;
        transition: transform 0.5s cubic-bezier(0.8, 0, 0.2, 1);
        /* Deep ambient background */
        background-image: radial-gradient(circle at 50% 100%, rgba(255, 59, 48, 0.1), transparent 60%);
    }
    .auth-container.out { transform: translateY(-100%); }

    .auth-card {
        width: 100%; max-width: 380px;
        background: var(--bg-surface-glass); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
        border: 1px solid var(--border);
        border-radius: 24px; padding: 40px 32px;
        box-shadow: 0 20px 40px -10px rgba(0,0,0,0.3);
        text-align: center; position: relative; overflow: hidden;
    }
    /* Top accent line */
    .auth-card::before {
        content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
        background: var(--accent-grad);
    }

    .auth-title { font-size: 1.8rem; font-weight: 800; color: var(--text-main); margin-bottom: 8px; letter-spacing: -0.03em; }
    .auth-subtitle { color: var(--text-sec); font-size: 0.9rem; margin-bottom: 32px; }
    
    .auth-input-group { margin-bottom: 16px; position: relative; text-align: left; }
    .auth-input {
        width: 100%; height: 52px; background: var(--bg-body);
        border: 1px solid var(--border); border-radius: 12px; padding: 0 16px;
        color: var(--text-main); font-family: var(--font-main); font-size: 1rem;
        transition: all 0.2s; outline: none;
    }
    .auth-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); background: var(--bg-surface); }
    .auth-input::placeholder { color: var(--text-muted); }

    .btn-auth {
        width: 100%; height: 52px; background: var(--accent-grad); color: #fff;
        border: none; border-radius: 12px; font-weight: 700; font-size: 1rem;
        cursor: pointer; transition: 0.2s; margin-top: 8px;
        box-shadow: 0 4px 20px var(--accent-glow);
    }
    .btn-auth:active { transform: scale(0.98); }

    .auth-footer { margin-top: 24px; font-size: 0.85rem; color: var(--text-sec); }
    .auth-link { color: var(--text-main); font-weight: 600; cursor: pointer; text-decoration: none; margin-left: 4px; }
    .auth-link:hover { text-decoration: underline; color: var(--accent); }

    /* Header */
    .app-header {
      position: sticky; top: 0; z-index: 50; height: var(--header-height);
      padding: 0 24px; display: flex; align-items: center; justify-content: space-between;
      background: var(--nav-glass); backdrop-filter: var(--blur); -webkit-backdrop-filter: var(--blur);
      border-bottom: 1px solid var(--border);
      transition: background 0.3s, border-color 0.3s;
    }

    .brand {
      font-size: 1.25rem; font-weight: 800; letter-spacing: -0.02em; color: var(--text-main);
      display: flex; align-items: center; gap: 10px; text-decoration: none;
    }
    .brand-icon {
        width: 10px; height: 10px; background: var(--accent); border-radius: 50%;
        box-shadow: 0 0 12px var(--accent-glow);
    }

    .user-avatar-btn {
      width: 40px; height: 40px; border-radius: 10px; background: var(--bg-surface);
      border: 1px solid var(--border); color: var(--text-main);
      display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem;
      cursor: pointer; overflow: hidden; transition: 0.2s;
    }
    .user-avatar-btn img { width: 100%; height: 100%; object-fit: cover; }

    /* Hero */
    .hero { padding: 24px 24px 10px; }
    .hero-banner {
      border-radius: var(--radius-lg); overflow: hidden; position: relative;
      padding: 32px 24px; display: flex; flex-direction: column; justify-content: flex-end;
      background: var(--bg-surface); border: 1px solid var(--border);
      min-height: 240px; box-shadow: var(--shadow-glow);
      transition: box-shadow 0.3s, border-color 0.3s;
    }
    .hero-banner::before {
        content: ''; position: absolute; inset: 0;
        /* Dynamic gradient overlay that works in both modes */
        background: linear-gradient(to bottom, rgba(0,0,0,0) 20%, rgba(0,0,0,0.6) 100%);
        pointer-events: none; z-index: 1;
    }
    .hero-img-bg {
        position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; 
        z-index: 0; filter: brightness(0.9);
        transition: transform 10s ease; animation: slowPan 20s infinite alternate;
    }
    @keyframes slowPan { from { transform: scale(1); } to { transform: scale(1.1); } }
    
    .hero-badge {
      font-family: var(--font-mono); font-size: 0.65rem; color: #fff;
      background: var(--accent); padding: 4px 10px; border-radius: 4px;
      display: inline-block; margin-bottom: 12px; font-weight: 700; width: fit-content;
      position: relative; z-index: 2; letter-spacing: 0.05em; box-shadow: 0 4px 10px var(--accent-glow);
    }
    .hero-title { font-size: 2.2rem; font-weight: 800; line-height: 1; margin-bottom: 8px; color: #fff; position: relative; z-index: 2; letter-spacing: -0.03em; text-shadow: 0 2px 20px rgba(0,0,0,0.3); }
    .hero-subtitle { font-size: 1rem; color: rgba(255,255,255,0.9); max-width: 90%; position: relative; z-index: 2; font-weight: 500; }

    /* Filter Pills */
    .filter-row { display: flex; gap: 12px; padding: 16px 24px; overflow-x: auto; scrollbar-width: none; }
    .filter-pill {
      background: var(--bg-surface); border: 1px solid var(--border); padding: 10px 20px;
      border-radius: 100px; color: var(--text-sec); font-weight: 600; font-size: 0.85rem;
      white-space: nowrap; transition: 0.2s; cursor: pointer;
    }
    .filter-pill.active { 
        background: var(--text-main); color: var(--bg-body); border-color: var(--text-main); 
        box-shadow: 0 4px 12px var(--shadow-sm);
    }

    /* --- TICKET STYLE (Adaptive) --- */
    .cards-grid { padding: 0 24px 40px; display: flex; flex-direction: column; gap: 28px; }
    
    .club-ticket {
      filter: drop-shadow(var(--shadow-sm));
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
    }
    .club-ticket:active { transform: scale(0.98); }

    /* Main Ticket Container */
    .ticket-container {
      background: var(--bg-ticket);
      border-radius: 16px;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border);
      
      /* The Cutouts */
      -webkit-mask-image: radial-gradient(circle at 0 72%, transparent 12px, black 12.5px), radial-gradient(circle at 100% 72%, transparent 12px, black 12.5px);
      mask-image: radial-gradient(circle at 0 72%, transparent 12px, black 12.5px), radial-gradient(circle at 100% 72%, transparent 12px, black 12.5px);
    }
    
    /* Red Accent Strip on Left */
    .ticket-strip {
        position: absolute; left: 0; top: 0; bottom: 0; width: 6px;
        background: var(--accent); opacity: 0.8; z-index: 5;
    }
    .club-ticket.joined .ticket-strip { box-shadow: 2px 0 15px var(--accent); opacity: 1; }

    /* Top Section (Event Info) */
    .ticket-body {
      padding: 24px 24px 20px 30px; /* Extra left padding for strip */
      position: relative;
    }
    
    .ticket-id-watermark {
        position: absolute; top: 20px; right: 20px;
        font-family: var(--font-barcode); font-size: 3rem; color: var(--border);
        opacity: 0.5; pointer-events: none; transform: rotate(-5deg);
    }

    .ticket-title { font-size: 1.6rem; font-weight: 800; color: var(--text-main); margin-bottom: 8px; line-height: 1.1; letter-spacing: -0.03em; max-width: 85%; }
    .ticket-desc { font-size: 0.95rem; color: var(--text-sec); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 24px; }

    .ticket-meta {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;
      padding-top: 16px; border-top: 2px dashed var(--border);
    }
    .meta-box { display: flex; flex-direction: column; gap: 4px; }
    .meta-label { font-family: var(--font-mono); font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; }
    .meta-val { font-size: 0.9rem; font-weight: 700; color: var(--text-main); }
    .meta-val.price { color: var(--accent); }

    /* Perforation Line (Visual) */
    .ticket-cut {
      height: 2px; width: 100%;
      background-image: linear-gradient(to right, var(--bg-body) 50%, transparent 50%);
      background-size: 20px 100%;
      opacity: 0.5; margin-top: 2px;
    }

    /* Stub Section (Actions) */
    .ticket-stub {
      padding: 20px 24px 24px 30px;
      background: var(--bg-surface);
      display: flex; justify-content: space-between; align-items: center;
      min-height: 85px; position: relative;
    }
    .ticket-stub::before {
        content: ''; position: absolute; inset: 0; 
        background: linear-gradient(to bottom, rgba(0,0,0,0.02), transparent);
        pointer-events: none;
    }
    
    /* QR Code Area */
    .stub-qr-container { display: flex; align-items: center; gap: 16px; width: 100%; position: relative; z-index: 2; }
    .qr-img {
        width: 64px; height: 64px;
        border-radius: 6px; background: #fff; padding: 4px;
        image-rendering: pixelated; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border: 1px solid var(--border);
    }
    .qr-text {
        font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-sec);
        display: flex; flex-direction: column; gap: 2px;
    }
    .qr-text strong { font-size: 0.9rem; color: var(--text-main); text-transform: uppercase; letter-spacing: -0.02em; }

    /* Barcode for Unjoined */
    .stub-left { flex: 1; display: flex; align-items: center; position: relative; z-index: 2; }
    .stub-barcode {
      font-family: var(--font-barcode); font-size: 2.2rem; color: var(--text-muted);
      opacity: 0.4; line-height: 1; transform: scaleY(1.2); letter-spacing: 2px;
    }

    /* Buttons */
    .btn-ticket {
      height: 44px; padding: 0 24px;
      background: var(--text-main); color: var(--bg-body);
      border: none; border-radius: 8px;
      font-family: var(--font-mono); font-size: 0.85rem; font-weight: 700;
      cursor: pointer; transition: 0.2s; letter-spacing: -0.02em; text-transform: uppercase;
    }
    .btn-ticket:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); opacity: 0.9; }
    
    .btn-icon {
        width: 44px; height: 44px; border-radius: 8px;
        border: 1px solid var(--border); background: rgba(127,127,127,0.05);
        color: var(--text-main); display: flex; align-items: center; justify-content: center;
        cursor: pointer; transition: 0.2s;
    }
    .btn-icon:hover { background: var(--bg-surface-glass); border-color: var(--text-sec); }
    .btn-icon.danger { color: #ef4444; border-color: rgba(239, 68, 68, 0.3); }
    .btn-icon.danger:hover { background: rgba(239, 68, 68, 0.1); border-color: #ef4444; }

    /* Modals */
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
      z-index: 200; opacity: 0; pointer-events: none; transition: opacity 0.2s;
    }
    .modal-backdrop.open { opacity: 1; pointer-events: auto; }
    
    .sheet {
      position: fixed; bottom: 0; left: 0; width: 100%;
      background: var(--bg-surface);
      border-top: 1px solid var(--border);
      border-radius: 28px 28px 0 0;
      padding: 0 0 calc(20px + var(--safe-bottom)); 
      transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.19, 1, 0.22, 1);
      z-index: 201; max-height: 92vh; display: flex; flex-direction: column;
      box-shadow: 0 -10px 50px rgba(0,0,0,0.2);
    }
    .modal-backdrop.open .sheet { transform: translateY(0); }
    
    .sheet-header { padding: 20px; display: flex; justify-content: center; align-items: center; position: relative; }
    .drag-handle { width: 40px; height: 4px; background: var(--border-highlight); border-radius: 100px; }
    .sheet-content { padding: 0 24px 24px; overflow-y: auto; }

    /* Input Styling */
    .input-group label { display: block; font-family: var(--font-mono); font-size: 0.7rem; color: var(--text-sec); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em; }
    .input-field {
      width: 100%; height: 56px; background: var(--bg-body);
      border: 1px solid var(--border); border-radius: 12px; padding: 0 16px;
      color: var(--text-main); font-family: var(--font-main); font-size: 1rem;
      transition: 0.2s; outline: none;
    }
    .input-field:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-glow); }
    
    .btn-main {
      width: 100%; height: 56px; background: var(--accent); color: #fff;
      border: none; border-radius: 14px; font-weight: 700; font-size: 1rem;
      cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 10px;
      box-shadow: 0 4px 15px rgba(255, 59, 48, 0.3); text-transform: uppercase; letter-spacing: 0.02em;
    }
    .btn-main:hover { background: var(--accent-dark); transform: translateY(-1px); box-shadow: 0 6px 20px rgba(255, 59, 48, 0.4); }

    /* Nav Bar - Floating Dock */
    .nav-wrapper { position: fixed; bottom: 32px; left: 0; right: 0; display: flex; justify-content: center; pointer-events: none; z-index: 100; }
    .nav-capsule {
      background: var(--nav-glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      padding: 8px; border-radius: 24px; display: flex; gap: 8px;
      pointer-events: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    }
    .nav-btn {
      width: 52px; height: 52px; border-radius: 18px; display: flex; align-items: center; justify-content: center;
      color: var(--text-sec); cursor: pointer; transition: 0.2s;
    }
    .nav-btn.active { color: var(--accent); background: var(--bg-body); }
    .nav-btn-main {
      width: 52px; height: 52px; border-radius: 18px; background: var(--text-main); color: var(--bg-body);
      display: flex; align-items: center; justify-content: center; margin: 0 4px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    /* Auth Styling */
    .auth-container {
        position: fixed; inset: 0; background: var(--bg-body); z-index: 2000;
        display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 32px;
        transition: transform 0.5s cubic-bezier(0.8, 0, 0.2, 1);
    }
    .auth-container.out { transform: translateY(-100%); }

    /* Toast */
    .toast {
      position: fixed; top: 24px; left: 50%; transform: translate(-50%, -100px);
      background: var(--bg-surface); border: 1px solid var(--border-highlight); 
      padding: 12px 24px; border-radius: 100px; display: flex; align-items: center; gap: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 3000;
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .toast.show { transform: translate(-50%, 0); }
    .toast-dot { width: 8px; height: 8px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 10px var(--accent); }
    .toast-msg { font-size: 0.9rem; font-weight: 600; color: var(--text-main); }

    /* Chat Styling */
    .chat-bubble.me { background: var(--accent); color: white; border: none; }
    
    /* Edit Profile */
    .avatar-upload { width: 100px; height: 100px; border-radius: 50%; background: var(--bg-surface); border: 2px dashed var(--border); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; cursor: pointer; }
    
    /* Map */
    #createMap { width: 100%; height: 200px; background: var(--bg-surface); border-radius: 16px; margin-bottom: 24px; display: none; overflow: hidden; border: 1px solid var(--border); }
    #createMap.visible { display: block; }
    
    /* Event Image */
    .event-cover-upload { width: 100%; height: 150px; border-radius: 16px; background: var(--bg-surface); border: 2px dashed var(--border); display: flex; align-items: center; justify-content: center; margin-bottom: 24px; overflow: hidden; cursor: pointer; position: relative; }
    .event-cover-upload img { width: 100%; height: 100%; object-fit: cover; display: none; }
    .details-image { width: 100%; height: 220px; object-fit: cover; border-radius: 16px; margin-bottom: 24px; box-shadow: var(--shadow-sm); }

  </style>
</head>
<body>

  <!-- Splash -->
  <div id="splashScreen">
    <div class="splash-logo">FIDA</div>
  </div>

  <!-- Auth -->
  <div id="authScreen" class="auth-container">
    <div class="auth-card">
        <h1 class="auth-title">FIDA</h1>
        <p class="auth-subtitle">Access the grid.</p>
        
        <form id="authForm" onsubmit="handleAuth(event)">
            <div id="nameGroup" class="auth-input-group hidden">
                <input type="text" id="authName" class="auth-input" placeholder="Codename">
            </div>
            <div class="auth-input-group">
                <input type="email" id="authEmail" class="auth-input" placeholder="Email Address" required>
            </div>
            <div class="auth-input-group">
                <input type="password" id="authPass" class="auth-input" placeholder="Passkey" required>
            </div>
            
            <button class="btn-auth">Initialize</button>
        </form>
        
        <div class="auth-footer">
            <span id="authSwitchLabel">New user?</span>
            <a onclick="toggleAuthMode()" class="auth-link">Create Identity</a>
        </div>
    </div>
  </div>

  <!-- Header -->
  <header class="app-header">
    <a href="#" class="brand">
      <div class="brand-icon"></div>
      FIDA
    </a>
    <div class="user-avatar-btn" id="headerAvatar" onclick="openProfile()">
      <span id="userInitials">G</span>
    </div>
  </header>

  <!-- Main -->
  <main id="mainView">
    <section class="hero">
      <div class="hero-banner">
        <span class="hero-badge">FEATURED EVENT</span>
        <h2 class="hero-title">Neon Nights<br>Tokyo Drift.</h2>
        <p class="hero-subtitle">Experience the unseen underground racing culture.</p>
        <img src="https://images.unsplash.com/photo-1555685812-4b943f3e9942?q=80&w=2070&auto=format&fit=crop" class="hero-img-bg" alt="Hero">
      </div>
    </section>

    <div class="filter-row">
      <div class="filter-pill active" onclick="filterClubs('all', this)">All Events</div>
      <div class="filter-pill" onclick="filterClubs('joined', this)">My Pass</div>
      <div class="filter-pill" onclick="filterClubs('new', this)">Latest</div>
    </div>

    <div id="clubsContainer" class="cards-grid">
      <!-- Injected -->
    </div>
  </main>

  <!-- Nav -->
  <div class="nav-wrapper">
    <div class="nav-capsule">
      <div class="nav-btn active" onclick="switchTab('home')">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
      </div>
      <div class="nav-btn" onclick="switchTab('explore')">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      </div>
      <div class="nav-btn-main" onclick="openCreateModal()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
      </div>
      <div class="nav-btn" onclick="switchTab('chats')">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
      </div>
      <div class="nav-btn" onclick="openProfile()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
      </div>
    </div>
  </div>

  <!-- Create Modal -->
  <div id="createModal" class="modal-backdrop">
    <div class="sheet">
      <div class="sheet-header"><div class="drag-handle"></div></div>
      <div class="sheet-content">
        <h2 style="font-size: 1.5rem; margin-bottom: 24px; color: var(--text-main); font-weight:800;">Create Event</h2>
        
        <label for="cImageInput">
            <div class="event-cover-upload" id="cImagePreview">
                <div style="text-align:center; color:var(--text-sec);">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin:0 auto 8px; display:block;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                    <span style="font-family:var(--font-mono); font-size:0.7rem;">ADD COVER PHOTO</span>
                </div>
                <img id="cImageDisplay">
            </div>
        </label>
        <input type="file" id="cImageInput" accept="image/*" style="display:none;" onchange="handleEventImage(this)">

        <form onsubmit="handleCreate(event)">
            <div class="input-group"><label>Event Title</label><input type="text" id="cName" class="input-field" placeholder="Ex: Cyber Punk Party" required></div>
            <div class="input-group"><label>Details</label><textarea id="cDesc" class="input-field" style="height: 120px; padding-top: 14px; resize: none;" placeholder="Full event description..." required></textarea></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="input-group"><label>Date</label><input type="date" id="cDate" class="input-field" required></div>
                <div class="input-group"><label>Time</label><input type="time" id="cTime" class="input-field" required></div>
            </div>
            <div class="input-group"><label>Ticket Price ($)</label><input type="number" id="cPrice" class="input-field" placeholder="0 for Free" min="0"></div>
            <div class="input-group"><label>Location</label><div style="display: flex; gap: 10px;"><input type="text" id="cLoc" class="input-field" placeholder="Search..." required><button type="button" class="btn-ticket" style="width:auto;" onclick="verifyLocation()">Map</button></div></div>
            <div id="createMap"></div>
            <button class="btn-main">Publish Drop</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Details Modal -->
  <div id="detailsModal" class="modal-backdrop">
    <div class="sheet">
      <div class="sheet-header"><div class="drag-handle"></div></div>
      <div class="sheet-content" id="detailsContent"></div>
    </div>
  </div>

  <!-- Chat Modal -->
  <div id="chatModal" class="modal-backdrop">
    <div class="sheet" style="height: 90vh;">
      <div class="sheet-header" style="border-bottom:1px solid var(--border); justify-content:space-between;">
        <div class="drag-handle" style="position:absolute; left:50%; transform:translateX(-50%);"></div>
        <div style="font-weight:700;" id="chatTitle">Chat</div>
      </div>
      <div id="chatHistory" class="chat-container" style="flex:1; overflow-y:auto; padding:20px;"></div>
      <form onsubmit="sendChat(event)" style="padding:16px; border-top:1px solid var(--border); display:flex; gap:12px;">
        <input type="text" id="chatInput" class="input-field" placeholder="Message..." style="height:48px;" autocomplete="off">
        <button class="btn-main" style="width:48px; height:48px; border-radius:50%; padding:0;"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button>
      </form>
    </div>
  </div>

  <!-- Profile/Settings Modals -->
  <div id="profileModal" class="modal-backdrop">
    <div class="sheet">
      <div class="sheet-header"><div class="drag-handle"></div></div>
      <div class="sheet-content">
          <div style="text-align: center; margin-bottom: 32px;">
            <div style="width: 90px; height: 90px; border-radius: 50%; background: var(--bg-surface); border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: 800; color: var(--text-main); margin: 0 auto 16px; overflow:hidden;" id="profileAvatarBig"><span id="profileAvatarInitial">G</span><img id="profileAvatarImg" style="width:100%; height:100%; object-fit:cover; display:none;"></div>
            <h2 id="profileName" style="margin-bottom: 4px; font-size: 1.5rem; font-weight: 800;">Guest</h2>
            <p style="color: var(--text-sec); font-size: 0.8rem; font-family: var(--font-mono);">MEMBER ID: #8291</p>
          </div>
          <div onclick="openEditProfile()" style="padding:16px; border-bottom:1px solid var(--border); cursor:pointer; display:flex; justify-content:space-between; align-items:center;"><span>Edit Profile</span><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
          <div onclick="openSettings()" style="padding:16px; border-bottom:1px solid var(--border); cursor:pointer; display:flex; justify-content:space-between; align-items:center;"><span>Settings</span><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
          <div onclick="logout()" style="padding:16px; color:#ef4444; cursor:pointer; display:flex; justify-content:space-between; align-items:center;"><span>Log Out</span></div>
      </div>
    </div>
  </div>

  <div id="editProfileModal" class="modal-backdrop"><div class="sheet"><div class="sheet-header"><div class="drag-handle"></div></div><div class="sheet-content"><h2 style="font-size:1.2rem; margin-bottom:24px; text-align:center; font-weight:800;">Edit Profile</h2><label for="avatarInput"><div class="avatar-upload" id="editAvatarPreview"><img id="editAvatarImg" style="display:none; width:100%; height:100%; object-fit:cover;"></div></label><input type="file" id="avatarInput" accept="image/*" style="display:none;" onchange="handleImageUpload(this)"><form onsubmit="saveProfile(event)"><div class="input-group"><label>Display Name</label><input type="text" id="editName" class="input-field" required></div><button class="btn-main">Save</button></form></div></div></div>
  
  <div id="settingsModal" class="modal-backdrop"><div class="sheet" style="height:100vh; border-radius:0;"><div style="padding:20px; display:flex; align-items:center; border-bottom:1px solid var(--border);"><div onclick="closeSettings()" style="margin-right:16px; cursor:pointer;">Back</div><h2 style="font-size:1.2rem; font-weight:800;">Settings</h2></div><div class="sheet-content" style="padding-top:24px;"><h3 style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px; text-transform:uppercase; letter-spacing:0.05em;">Preferences</h3><div class="input-group" onclick="toggleTheme()" style="padding:16px 0; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; cursor:pointer;"><div style="color:var(--text-main); font-weight:500;">Dark Mode</div><div style="color:var(--text-sec);" id="themeStatus">On</div></div><h3 style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px; margin-top:32px; text-transform:uppercase; letter-spacing:0.05em;">Account</h3><div style="padding:16px 0;">Email: <span id="settingsEmail" style="color:var(--text-sec);"></span></div></div></div></div>

  <div id="toast" class="toast"><div class="toast-dot"></div><span id="toastMsg" class="toast-msg">Success</span></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    /* =========================================
       APP LOGIC
       ========================================= */
    const MOCK_USERS = [{name:"Kiera"},{name:"Jaxon"},{name:"Zane"},{name:"Nia"}];
    const DEFAULT_CLUBS = [
        { id: 'c1', title: 'Midnight Run', desc: '5K through the city center. Casual pace for night owls.', date: '2025-10-15', time: '23:00', location: 'New York, NY', lat: 40.7128, lng: -74.0060, attendees: 42, capacity: 50, price: 'Free', image: 'https://images.unsplash.com/photo-1470225620780-dba8ba36b745?q=80&w=2070&auto=format&fit=crop' },
        { id: 'c2', title: 'Analog Walk', desc: 'Photography walk focusing on brutalist structures and shadows.', date: '2025-10-18', time: '18:30', location: 'London, UK', lat: 51.5074, lng: -0.1278, attendees: 8, capacity: 12, price: '$25', image: 'https://images.unsplash.com/photo-1542204165-65bf26472b9b?q=80&w=1974&auto=format&fit=crop' },
        { id: 'c3', title: 'Synth Yoga', desc: 'Deep stretching to heavy synth beats on a rooftop.', date: '2025-10-20', time: '19:00', location: 'Tokyo, Japan', lat: 35.6762, lng: 139.6503, attendees: 15, capacity: 20, price: '$15', image: 'https://images.unsplash.com/photo-1575052814086-f385e2e2ad1b?q=80&w=2070&auto=format&fit=crop' }
    ];

    let clubs = JSON.parse(localStorage.getItem('fida_clubs')) || DEFAULT_CLUBS;
    
    // Ensure data integrity
    clubs = clubs.map(c => ({
        ...c,
        attendeesList: c.attendeesList || [],
        chat: c.chat || [],
        price: c.price || 'Free',
        image: c.image || 'https://images.unsplash.com/photo-1492684223066-81342ee5ff30?q=80&w=2070&auto=format&fit=crop' // fallback
    }));
    
    localStorage.setItem('fida_clubs', JSON.stringify(clubs));

    let currentUser = JSON.parse(localStorage.getItem('fida_user')) || null;
    let myJoinedIds = JSON.parse(localStorage.getItem('fida_joined')) || ['c1'];
    let activeClubId = null; let map = null; let createMap = null; let createMarker = null; let tempCoordinates = null; let isSignUp = false; 
    let tempAvatarBase64 = null;
    let tempEventImageBase64 = null;

    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => { document.getElementById('splashScreen').classList.add('hide'); }, 2000);
        initializeTheme(); checkAuth(); renderClubs(); updateProfileUI();
        document.querySelectorAll('.modal-backdrop').forEach(m => { m.addEventListener('click', e => { if(e.target === m) closeModal(m.querySelector('.sheet').parentElement.id); }); });
    });
    
    function initializeTheme() { if(localStorage.getItem('fida_theme')==='light') document.documentElement.setAttribute('data-theme', 'light'); }
    function toggleTheme() {
        const curr = document.documentElement.getAttribute('data-theme');
        if(curr==='light') { document.documentElement.removeAttribute('data-theme'); localStorage.setItem('fida_theme', 'dark'); }
        else { document.documentElement.setAttribute('data-theme', 'light'); localStorage.setItem('fida_theme', 'light'); }
    }
    function checkAuth() { if (!currentUser) document.getElementById('authScreen').classList.remove('out'); else { document.getElementById('authScreen').classList.add('out'); updateProfileUI(); } }
    function toggleAuthMode() { isSignUp=!isSignUp; const n=document.getElementById('nameGroup'); const b=document.querySelector('#authForm button'); const s=document.getElementById('authSwitchLabel'); if(isSignUp){n.classList.remove('hidden');b.textContent='REGISTER ID';s.innerHTML="LOGIN";}else{n.classList.add('hidden');b.textContent='INITIALIZE';s.innerHTML="REGISTER ID";} }
    function handleAuth(e) {
        e.preventDefault(); currentUser = { email:document.getElementById('authEmail').value, name:document.getElementById('authName').value||"Guest", initial:(document.getElementById('authName').value||"G").charAt(0).toUpperCase(), avatar:null };
        localStorage.setItem('fida_user', JSON.stringify(currentUser)); checkAuth(); showToast("ACCESS GRANTED");
    }
    function logout() { localStorage.removeItem('fida_user'); currentUser=null; closeModal('profileModal'); checkAuth(); }
    function updateProfileUI() { if(currentUser) { if(currentUser.avatar){document.getElementById('headerAvatar').innerHTML=`<img src="${currentUser.avatar}">`;}else{document.getElementById('headerAvatar').innerText=currentUser.initial;} document.getElementById('profileName').innerText=currentUser.name; document.getElementById('settingsEmail').innerText=currentUser.email; } }
    
    function openEditProfile(){ closeModal('profileModal'); document.getElementById('editName').value=currentUser.name; openModal('editProfileModal'); }
    function handleImageUpload(i){ if(i.files[0]){const r=new FileReader();r.onload=e=>{document.getElementById('editAvatarImg').src=e.target.result;document.getElementById('editAvatarImg').style.display='block';tempAvatarBase64=e.target.result;};r.readAsDataURL(i.files[0]);} }
    function saveProfile(e){ e.preventDefault(); currentUser.name=document.getElementById('editName').value; if(tempAvatarBase64)currentUser.avatar=tempAvatarBase64; localStorage.setItem('fida_user',JSON.stringify(currentUser)); updateProfileUI(); closeModal('editProfileModal'); showToast("ID UPDATED"); }

    function renderClubs(filter='all') {
        const container = document.getElementById('clubsContainer'); container.innerHTML = '';
        let filtered = clubs;
        if(filter === 'joined') filtered = clubs.filter(c => myJoinedIds.includes(c.id));
        if(filter === 'new') filtered = [...clubs].reverse();
        if(filtered.length === 0) { container.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-muted); font-family:var(--font-data);">NO DATA FOUND</div>`; return; }

        filtered.forEach(club => {
            const isJoined = myJoinedIds.includes(club.id);
            const isFull = club.attendees >= club.capacity;
            const isHost = club.hostEmail === (currentUser ? currentUser.email : '');
            
            // GENERATE QR URL
            const qrData = `${club.id}-${currentUser ? currentUser.email : 'guest'}`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrData)}&color=000000&bgcolor=ffffff`;

            const html = `
                <div class="club-ticket ${isJoined ? 'joined' : ''}" onclick="openDetails('${club.id}')">
                    <div class="ticket-container">
                        <div class="ticket-strip"></div>
                        <div class="ticket-body">
                            <div class="ticket-id-watermark">NO.${club.id.toUpperCase()}</div>
                            <div class="ticket-status-pill">${isJoined ? 'PASS ACTIVE' : (isFull ? 'SOLD OUT' : 'AVAILABLE')}</div>
                            <div style="min-height: 90px;">
                                ${isHost ? '<span style="color:var(--accent); font-size:0.7rem; font-weight:700; display:block; margin-bottom:4px;">HOST</span>' : ''}
                                <h3 class="ticket-title">${club.title}</h3>
                                <p class="ticket-desc">${club.desc}</p>
                            </div>
                            <div class="ticket-meta">
                                <div class="meta-box"><span class="meta-label">Date</span><span class="meta-val">${new Date(club.date).toLocaleDateString('en-US',{month:'short',day:'numeric'})}</span></div>
                                <div class="meta-box"><span class="meta-label">Time</span><span class="meta-val">${club.time}</span></div>
                                <div class="meta-box"><span class="meta-label">Price</span><span class="meta-val price">${club.price}</span></div>
                            </div>
                        </div>
                        <div class="ticket-cut"></div>
                        <div class="ticket-stub">
                            ${isJoined 
                                ? `<div class="stub-qr-container">
                                     <img src="${qrUrl}" class="qr-img" alt="Entry QR">
                                     <div class="qr-text"><strong>Scan Entry</strong><span>${club.id.toUpperCase()}</span></div>
                                     <div style="flex:1;"></div>
                                     <button class="btn-icon" onclick="event.stopPropagation(); openChat('${club.id}')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg></button>
                                     <button class="btn-icon danger" onclick="event.stopPropagation(); leaveClub('${club.id}')"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg></button>
                                   </div>`
                                : `<div class="stub-left"><div class="stub-barcode">*${club.id.toUpperCase()}*</div></div>
                                   <button class="btn-ticket" onclick="event.stopPropagation(); joinClub('${club.id}')" ${isFull?'disabled':''}>${isFull?'Sold Out':'Get Pass'}</button>`
                            }
                        </div>
                    </div>
                </div>`;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    function filterClubs(t, el) { document.querySelectorAll('.filter-pill').forEach(c=>c.classList.remove('active')); el.classList.add('active'); renderClubs(t); }
    function switchTab(t) { 
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); event.currentTarget.classList.add('active');
        if(t==='home'){document.getElementById('mainView').classList.remove('hidden'); renderClubs('all');}
        else if(t==='explore'){renderClubs('new');}
        else if(t==='chats'){renderClubs('joined'); showToast('ACCESS GRANTED');}
    }

    function joinClub(id) {
        if(myJoinedIds.includes(id)) return;
        const c = clubs.find(c=>c.id===id); c.attendees++;
        c.attendeesList.push({name:currentUser.name, avatar:currentUser.avatar, email:currentUser.email});
        myJoinedIds.push(id); localStorage.setItem('fida_joined', JSON.stringify(myJoinedIds)); localStorage.setItem('fida_clubs', JSON.stringify(clubs));
        renderClubs(); showToast('TICKET PRINTED');
        setTimeout(() => { c.chat.push({user:'System', text:'Welcome to the grid.'}); localStorage.setItem('fida_clubs', JSON.stringify(clubs)); }, 1000);
    }
    function leaveClub(id) {
        myJoinedIds=myJoinedIds.filter(i=>i!==id); const c=clubs.find(c=>c.id===id); c.attendees--;
        c.attendeesList=c.attendeesList.filter(u=>u.email!==currentUser.email);
        localStorage.setItem('fida_joined', JSON.stringify(myJoinedIds)); localStorage.setItem('fida_clubs', JSON.stringify(clubs));
        renderClubs(); showToast('TICKET VOIDED');
    }

    function openCreateModal(){
        openModal('createModal');
        document.getElementById('cImageDisplay').style.display = 'none';
        document.getElementById('cImageInput').value = '';
        tempEventImageBase64 = null;
    }
    function handleEventImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('cImageDisplay');
                img.src = e.target.result;
                img.style.display = 'block';
                tempEventImageBase64 = e.target.result;
            }
            reader.readAsDataURL(input.files[0]);
        }
    }
    function initCreateMap(){if(!createMap){createMap=L.map('createMap').setView([51.5,-0.09],13);L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:''}).addTo(createMap);createMap.on('click',e=>{if(createMarker)createMap.removeLayer(createMarker);createMarker=L.marker(e.latlng).addTo(createMap);tempCoordinates=e.latlng;});}}
    function verifyLocation(){const q=document.getElementById('cLoc').value;if(!q)return;document.getElementById('createMap').classList.add('visible');if(!createMap)initCreateMap();setTimeout(()=>{createMap.invalidateSize();fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`).then(r=>r.json()).then(d=>{if(d[0]){const lat=parseFloat(d[0].lat),lon=parseFloat(d[0].lon);if(createMarker)createMap.removeLayer(createMarker);createMarker=L.marker([lat,lon]).addTo(createMap);createMap.setView([lat,lon],13);tempCoordinates={lat,lng:lon};}});},300);}
    function handleCreate(e){
        e.preventDefault();
        const n={
            id:'c'+Date.now(),
            title:document.getElementById('cName').value,
            desc:document.getElementById('cDesc').value,
            date:document.getElementById('cDate').value,
            time:document.getElementById('cTime').value,
            location:document.getElementById('cLoc').value,
            lat:tempCoordinates?tempCoordinates.lat:0,
            lng:tempCoordinates?tempCoordinates.lng:0,
            attendees:1,
            capacity:50,
            chat:[],
            hostEmail:currentUser.email,
            price:document.getElementById('cPrice').value>0?`$${document.getElementById('cPrice').value}`:'Free',
            attendeesList:[currentUser],
            image: tempEventImageBase64 || 'https://images.unsplash.com/photo-1492684223066-81342ee5ff30?q=80&w=2070&auto=format&fit=crop'
        };
        clubs.unshift(n);
        myJoinedIds.push(n.id);
        localStorage.setItem('fida_clubs',JSON.stringify(clubs));
        localStorage.setItem('fida_joined',JSON.stringify(myJoinedIds));
        closeModal('createModal');
        renderClubs();
        showToast("DROP LIVE");
        e.target.reset();
    }

    function openDetails(id) {
        const c = clubs.find(c => c.id === id); const isJoined = myJoinedIds.includes(id); activeClubId = id;
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(c.id+'-'+currentUser.email)}&color=000000&bgcolor=ffffff`;
        
        let actions = isJoined ? `
            <div style="text-align:center; margin-bottom:24px; background:var(--bg-ticket); padding:20px; border:1px solid var(--accent);">
                <img src="${qrUrl}" style="width:160px; height:160px; border:2px solid #fff; padding:4px; background:white; margin-bottom:12px; image-rendering:pixelated;">
                <div style="font-family:var(--font-mono); font-size:0.8rem; color:var(--text-sec);">TOKEN: ${c.id.toUpperCase()}</div>
            </div>
            <div style="display:flex; gap:12px;">
                <button class="btn-main" onclick="openChat('${id}')" style="flex:1; background:var(--bg-surface); border:1px solid var(--accent); color:var(--accent); box-shadow:none;">CHAT</button>
                <button class="btn-icon danger" style="width:56px; height:56px;" onclick="leaveClub('${id}'); closeModal('detailsModal')"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"></path></svg></button>
            </div>` 
            : `<button class="btn-main" onclick="joinClub('${id}'); closeModal('detailsModal')">ACQUIRE TICKET â€¢ ${c.price}</button>`;
            
        document.getElementById('detailsContent').innerHTML = `
            ${c.image ? `<img src="${c.image}" class="details-image">` : ''}
            <h1 style="font-family:var(--font-main); font-size:2rem; font-weight:700; line-height:1.1; margin-bottom:12px; color:var(--text-main); text-shadow:2px 2px 0 var(--nav-glass);">${c.title}</h1>
            <p style="color:var(--text-sec); line-height:1.6; margin-bottom:32px; font-family:var(--font-mono); white-space: pre-wrap;">${c.desc}</p>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:32px;">
                <div style="background:rgba(0,0,0,0.5); padding:12px; border:1px solid var(--border);"><div style="font-family:var(--font-main); font-size:0.6rem; color:var(--accent);">DATE</div><div style="font-weight:700;">${new Date(c.date).toLocaleDateString()}</div></div>
                <div style="background:rgba(0,0,0,0.5); padding:12px; border:1px solid var(--border);"><div style="font-family:var(--font-main); font-size:0.6rem; color:var(--accent);">LOC</div><div style="font-weight:700;">${c.location}</div></div>
            </div>
            ${actions}`;
        openModal('detailsModal');
    }

    function openChat(id) { closeModal('detailsModal'); activeClubId = id; document.getElementById('chatTitle').innerText = clubs.find(c=>c.id===id).title; renderChat(); openModal('chatModal'); }
    function renderChat() {
        const c = clubs.find(c=>c.id===activeClubId); const h = document.getElementById('chatHistory'); h.innerHTML = '';
        if(!c.chat) c.chat=[];
        c.chat.forEach(m => {
            const d = document.createElement('div'); d.className = `chat-row ${m.user==='Me'?'me':'them'}`;
            d.innerHTML = `${m.user!=='Me'?`<div class="chat-avatar">${m.user.charAt(0)}</div>`:''}<div class="chat-bubble ${m.user==='Me'?'me':''}">${m.text}</div>`;
            h.appendChild(d);
        });
        h.scrollTop = h.scrollHeight;
    }
    function sendChat(e) {
        e.preventDefault(); const i = document.getElementById('chatInput'); if(!i.value.trim())return;
        const c = clubs.find(x=>x.id===activeClubId);
        c.chat.push({user:'Me', text:i.value}); localStorage.setItem('fida_clubs',JSON.stringify(clubs)); renderChat(); i.value='';
        setTimeout(()=>{c.chat.push({user:'Bot', text:'Acknowledged.'}); localStorage.setItem('fida_clubs',JSON.stringify(clubs)); if(document.getElementById('chatModal').classList.contains('open'))renderChat();},1000);
    }

    // Helpers
    function openModal(id) { document.getElementById(id).classList.add('open'); }
    function closeModal(id) { document.getElementById(id).classList.remove('open'); }
    function openProfile(){openModal('profileModal');} function openSettings(){openModal('settingsModal');} function closeSettings(){closeModal('settingsModal');}
    function showToast(m){const t=document.getElementById('toast');document.getElementById('toastMsg').innerText=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}
  </script>
</body>
</html>